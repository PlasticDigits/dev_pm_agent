# Dev PM Agent â€” Render Blueprint
# See docs: https://docs.render.com/blueprint-spec
#
# Before deploy: Set JWT_SECRET and EXECUTOR_API_KEY for dev-pm-relayer in Render Dashboard.
# After relayer deploys: Set VITE_RELAYER_URL for dev-pm-webapp (e.g. https://dev-pm-relayer.onrender.com).

services:
  # Backend: HTTP API + WebSocket, SQLite on persistent disk
  - type: web
    name: dev-pm-relayer
    runtime: rust
    plan: starter
    region: oregon

    buildCommand: cargo build --release -p relayer
    startCommand: ./target/release/relayer

    healthCheckPath: /health

    envVars:
      - key: DATABASE_PATH
        value: /data/relayer.db
      - key: JWT_SECRET
        sync: false
      - key: EXECUTOR_API_KEY
        sync: false
      - key: PASSWORD_SALT
        sync: false
      # CORS: set to frontend origin, e.g. https://dev-pm-webapp.onrender.com
      - key: CORS_ALLOWED_ORIGINS
        sync: false


    disk:
      name: data
      mountPath: /data
      sizeGB: 1

    buildFilter:
      paths:
        - crates/relayer/**
        - crates/shared/**
        - Cargo.toml
        - Cargo.lock

  # Frontend: Vite React SPA (static sites are free; plan not applicable)
  - type: web
    name: dev-pm-webapp
    runtime: static

    buildCommand: cd apps/web && npm install && npm run build
    staticPublishPath: apps/web/dist

    routes:
      - type: rewrite
        source: /*
        destination: /index.html

    buildFilter:
      paths:
        - apps/web/**
